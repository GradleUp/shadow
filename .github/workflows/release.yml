name: Release

on:
  push:
    tags:
      - '**'

jobs:
  maven-release:
    uses: ./.github/workflows/maven.yml
    with:
      plugin-portal: true

  deploy-sites:
    uses: ./.github/workflows/deploy.yml

  gh-release:
    runs-on: ubuntu-latest
    if: github.event.repository.fork == false
    needs:
      - deploy-sites
      - maven-release
    steps:
      - uses: actions/checkout@v4
      - name: Extract release notes
        uses: ffurrer2/extract-release-notes@v2
        with:
          changelog_file: docs/changes/README.md
          release_notes_file: RELEASE_NOTES.md
      - name: Create release
        run: gh release create ${{ github.ref_name }} --notes-file RELEASE_NOTES.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
